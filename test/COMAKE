#edimode: -*- python -*-
#coding:gbk

WORKROOT('../../../..')
CXXFLAGS('-g -pipe -Wall -W -fPIC -Wno-invalid-offsetof -fstrict-aliasing -Wno-unused-parameter -fno-omit-frame-pointer -std=c++0x -include brpc/config.h')
CFLAGS('-g -pipe -Wall -W -fPIC -fstrict-aliasing -Wno-unused-parameter -fno-omit-frame-pointer')
CPPFLAGS('-D__const__= -DUSE_SYMBOLIZE -DNO_TCMALLOC -DUNIT_TEST -Dprivate=public -Dprotected=public -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS -D__STDC_CONSTANT_MACROS -DBVAR_NOT_LINK_DEFAULT_VARIABLES')
LDFLAGS('-lpthread -lrt -lssl -lcrypto -ldl -lz')
INCPATHS('..')
CONFIGS('third-64/gflags@base')
CONFIGS('third-64/gtest@gtest_1-7-0-100_PD_BL')
CONFIGS('third-64/protobuf@protobuf_2-4-1-1100_PD_BL')
CONFIGS('third-64/tcmalloc@1.7.0.200',Libraries('lib/libprofiler.a'))
CONFIGS('third-64/leveldb@leveldb_1-0-0-0_PD_BL')   # rpcz

base_sources = [
    "../base/third_party/dmg_fp/g_fmt.cc",
    "../base/third_party/dmg_fp/dtoa_wrapper.cc",
    "../base/third_party/dmg_fp/dtoa.cc",
    "../base/third_party/dynamic_annotations/dynamic_annotations.c",
    "../base/third_party/icu/icu_utf.cc",
    "../base/third_party/superfasthash/superfasthash.c",
    "../base/third_party/modp_b64/modp_b64.cc",
    "../base/third_party/nspr/prtime.cc",
    "../base/third_party/symbolize/demangle.cc",
    "../base/third_party/symbolize/symbolize.cc",
    "../base/third_party/xdg_mime/xdgmime.c",
    "../base/third_party/xdg_mime/xdgmimealias.c",
    "../base/third_party/xdg_mime/xdgmimecache.c",
    "../base/third_party/xdg_mime/xdgmimeglob.c",
    "../base/third_party/xdg_mime/xdgmimeicon.c",
    "../base/third_party/xdg_mime/xdgmimeint.c",
    "../base/third_party/xdg_mime/xdgmimemagic.c",
    "../base/third_party/xdg_mime/xdgmimeparent.c",
    "../base/third_party/xdg_user_dirs/xdg_user_dir_lookup.cc",
    "../base/third_party/snappy/snappy-sinksource.cc",
    "../base/third_party/snappy/snappy-stubs-internal.cc",
    "../base/third_party/snappy/snappy.cc",
    "../base/third_party/murmurhash3/murmurhash3.cpp",
    "../base/allocator/type_profiler_control.cc",
    "../base/arena.cpp",
    "../base/at_exit.cc",
    "../base/atomicops_internals_x86_gcc.cc",
    "../base/barrier_closure.cc",
    "../base/base_paths.cc",
    "../base/base_paths_posix.cc",
    "../base/base64.cc",
    "../base/base_switches.cc",
    "../base/big_endian.cc",
    "../base/bind_helpers.cc",
    "../base/build_time.cc",
    "../base/callback_helpers.cc",
    "../base/callback_internal.cc",
    "../base/command_line.cc",
    "../base/cpu.cc",
    "../base/debug/alias.cc",
    "../base/debug/asan_invalid_access.cc",
    "../base/debug/crash_logging.cc",
    "../base/debug/debugger.cc",
    "../base/debug/debugger_posix.cc",
    "../base/debug/dump_without_crashing.cc",
    "../base/debug/proc_maps_linux.cc",
    "../base/debug/stack_trace.cc",
    "../base/debug/stack_trace_posix.cc",
    "../base/environment.cc",
    "../base/files/file.cc",
    "../base/files/file_posix.cc",
    "../base/files/file_enumerator.cc",
    "../base/files/file_enumerator_posix.cc",
    "../base/files/file_path.cc",
    "../base/files/file_path_constants.cc",
    "../base/files/memory_mapped_file.cc",
    "../base/files/memory_mapped_file_posix.cc",
    "../base/files/scoped_file.cc",
    "../base/files/scoped_temp_dir.cc",
    "../base/file_util.cc",
    "../base/file_util_linux.cc",
    "../base/file_util_posix.cc",
    "../base/guid.cc",
    "../base/guid_posix.cc",
    "../base/hash.cc",
    "../base/lazy_instance.cc",
    "../base/location.cc",
    "../base/md5.cc",
    "../base/memory/aligned_memory.cc",
    "../base/memory/ref_counted.cc",
    "../base/memory/ref_counted_memory.cc",
    "../base/memory/shared_memory_posix.cc",
    "../base/memory/singleton.cc",
    "../base/memory/weak_ptr.cc",
    "../base/nix/mime_util_xdg.cc",
    "../base/nix/xdg_util.cc",
    "../base/path_service.cc",
    "../base/posix/file_descriptor_shuffle.cc",
    "../base/posix/global_descriptors.cc",
    "../base/process/internal_linux.cc",
    "../base/process/kill.cc",
    "../base/process/kill_posix.cc",
    "../base/process/launch.cc",
    "../base/process/launch_posix.cc",
    "../base/process/memory.cc",
    "../base/process/memory_linux.cc",
    "../base/process/process_handle_linux.cc",
    "../base/process/process_handle_posix.cc",
    "../base/process/process_info_linux.cc",
    "../base/process/process_iterator.cc",
    "../base/process/process_iterator_linux.cc",
    "../base/process/process_linux.cc",
    "../base/process/process_metrics.cc",
    "../base/process/process_metrics_linux.cc",
    "../base/process/process_metrics_posix.cc",
    "../base/process/process_posix.cc",
    "../base/rand_util.cc",
    "../base/rand_util_posix.cc",
    "../base/fast_rand.cpp",
    "../base/safe_strerror_posix.cc",
    "../base/sha1_portable.cc",
    "../base/strings/latin1_string_conversions.cc",
    "../base/strings/nullable_string16.cc",
    "../base/strings/safe_sprintf.cc",
    "../base/strings/string16.cc",
    "../base/strings/string_number_conversions.cc",
    "../base/strings/string_split.cc",
    "../base/strings/string_piece.cc",
    "../base/strings/string_util.cc",
    "../base/strings/string_util_constants.cc",
    "../base/strings/stringprintf.cc",
    "../base/strings/sys_string_conversions_posix.cc",
    "../base/strings/utf_offset_string_conversions.cc",
    "../base/strings/utf_string_conversion_utils.cc",
    "../base/strings/utf_string_conversions.cc",
    "../base/synchronization/cancellation_flag.cc",
    "../base/synchronization/condition_variable_posix.cc",
    "../base/synchronization/waitable_event_posix.cc",
    "../base/sys_info.cc",
    "../base/sys_info_linux.cc",
    "../base/sys_info_posix.cc",
    "../base/threading/non_thread_safe_impl.cc",
    "../base/threading/platform_thread_linux.cc",
    "../base/threading/platform_thread_posix.cc",
    "../base/threading/simple_thread.cc",
    "../base/threading/thread_checker_impl.cc",
    "../base/threading/thread_collision_warner.cc",
    "../base/threading/thread_id_name_manager.cc",
    "../base/threading/thread_local_posix.cc",
    "../base/threading/thread_local_storage.cc",
    "../base/threading/thread_local_storage_posix.cc",
    "../base/threading/thread_restrictions.cc",
    "../base/threading/watchdog.cc",
    "../base/time/clock.cc",
    "../base/time/default_clock.cc",
    "../base/time/default_tick_clock.cc",
    "../base/time/tick_clock.cc",
    "../base/time/time.cc",
    "../base/time/time_posix.cc",
    "../base/version.cc",
    "../base/logging.cc",
    "multiprocess_func_list.cc",
    "test_switches.cc",
    "test_timeouts.cc",
    "scoped_locale.cc",
    "multiprocess_test.cc",
    "test_file_util.cc",
    "test_file_util_linux.cc",
    
    "../base/class_name.cpp",
    "../base/errno.cpp", 
    "../base/find_cstr.cpp",
    "../base/status.cpp",
    "../base/string_printf.cpp",
    "../base/thread_local.cpp",
    "../base/unix_socket.cpp",
    "../base/endpoint.cpp",
    "../base/fd_utility.cpp",
    "../base/files/temp_file.cpp",
    "../base/files/file_watcher.cpp",
    "../base/time.cpp",
    "../base/zero_copy_stream_as_streambuf.cpp",
    "../base/crc32c.cc",
    "../base/containers/case_ignored_flat_map.cpp",
    "../base/iobuf.cpp",
]

base_ut = [
    # "allocator_unittest.cc",  # not work in glibc 2.12
    "at_exit_unittest.cc",
    "atomicops_unittest.cc",
    "barrier_closure_unittest.cc",
    "base64_unittest.cc",
    "big_endian_unittest.cc",
    "bind_unittest.cc",
    "bits_unittest.cc",
    "build_time_unittest.cc",
    "callback_helpers_unittest.cc",
    "callback_list_unittest.cc",
    "callback_unittest.cc",
    "cancelable_callback_unittest.cc",
    "command_line_unittest.cc",
    "hash_tables_unittest.cc",
    "linked_list_unittest.cc",
    "mru_cache_unittest.cc",
    "small_map_unittest.cc",
    "stack_container_unittest.cc",
    "cpu_unittest.cc",
    "crash_logging_unittest.cc",
    "leak_tracker_unittest.cc",
    "proc_maps_linux_unittest.cc",
    "stack_trace_unittest.cc",
    "environment_unittest.cc",
    "file_util_unittest.cc",
    "dir_reader_posix_unittest.cc",
    "file_path_unittest.cc",
    "file_unittest.cc",
    "path_service_unittest.cc",
    "scoped_temp_dir_unittest.cc",
    "guid_unittest.cc",
    "hash_unittest.cc",
    "lazy_instance_unittest.cc",
    "md5_unittest.cc",
    "aligned_memory_unittest.cc",
    "linked_ptr_unittest.cc",
    "ref_counted_memory_unittest.cc",
    "ref_counted_unittest.cc",
    "scoped_ptr_unittest.cc",
    "scoped_vector_unittest.cc",
    #"shared_memory_unittest.cc",    # not work on many machines.
    "singleton_unittest.cc",
    "weak_ptr_unittest.cc",
    "observer_list_unittest.cc",
    "file_descriptor_shuffle_unittest.cc",
    "memory_unittest.cc",
    "process_metrics_unittest.cc",
    "process_util_unittest.cc",
    "rand_util_unittest.cc",
    "safe_numerics_unittest.cc",
    "scoped_clear_errno_unittest.cc",
    "scoped_generic_unittest.cc",
    "security_unittest.cc",
    "sha1_unittest.cc",
    "stl_util_unittest.cc",
    "nullable_string16_unittest.cc",
    "safe_sprintf_unittest.cc",
    "string16_unittest.cc",
    "stringprintf_unittest.cc",
    "string_number_conversions_unittest.cc",
    "string_piece_unittest.cc",
    "string_split_unittest.cc",
    "string_tokenizer_unittest.cc",
    "string_util_unittest.cc",
    "stringize_macros_unittest.cc",
    "sys_string_conversions_unittest.cc",
    "utf_offset_string_conversions_unittest.cc",
    "utf_string_conversions_unittest.cc",
    "cancellation_flag_unittest.cc",
    "condition_variable_unittest.cc",
    "lock_unittest.cc",
    "waitable_event_unittest.cc",
    "sys_info_unittest.cc",
    "type_traits_unittest.cc",
    "non_thread_safe_unittest.cc",
    "platform_thread_unittest.cc",
    "simple_thread_unittest.cc",
    "thread_checker_unittest.cc",
    "thread_collision_warner_unittest.cc",
    "thread_id_name_manager_unittest.cc",
    "thread_local_storage_unittest.cc",
    "thread_local_unittest.cc",
    "watchdog_unittest.cc",
    "pr_time_unittest.cc",
    "time_unittest.cc",
    "version_unittest.cc",
    "logging_unittest.cc",
    "tuple_unittest.cc",
    "xdg_util_unittest.cc",

    "cacheline_unittest.cpp",
    "class_name_unittest.cpp",
    "endpoint_unittest.cpp",
    "unique_ptr_unittest.cpp",
    "errno_unittest.cpp",
    "fd_guard_unittest.cpp",
    "file_watcher_unittest.cpp",
    "find_cstr_unittest.cpp",
    "scoped_lock_unittest.cpp",
    "status_unittest.cpp",
    "string_printf_unittest.cpp",
    "string_splitter_unittest.cpp",
    "synchronous_event_unittest.cpp",
    "temp_file_unittest.cpp",
    "baidu_thread_local_unittest.cpp",
    "baidu_time_unittest.cpp",
    "flat_map_unittest.cpp",
    "crc32c_unittest.cc",
    
    "base_unittest_main.cpp"
]
opt_base_ut = [
    "resource_pool_unittest.cpp",
    "object_pool_unittest.cpp",
]

opt_cxx_flags = ENV.CxxFlags() + CxxFlags('-O2')
base_sources_str = ' '.join(base_sources);

StaticLibrary('base_debug', Sources(base_sources_str))
StaticLibrary('bvar_debug', Sources(GLOB('../bvar/*.cpp ../bvar/detail/*.cpp'), opt_cxx_flags))
StaticLibrary('bthread_debug', Sources(GLOB('../bthread/*.cpp'), opt_cxx_flags))
StaticLibrary('brpc_debug',
              Sources(GLOB('../brpc/*.cpp ../brpc/policy/*.cpp ../brpc/builtin/*.cpp ../brpc/details/*.cpp ../brpc/*.pb.cc ../brpc/policy/*.pb.cc'))
              - Sources('../brpc/policy/baidu_naming_service.cpp ../brpc/policy/giano_authenticator.cpp'))
StaticLibrary('json2pb_debug', Sources(GLOB('../json2pb/*.cpp')))
StaticLibrary('mcpack2pb_debug', Sources(GLOB('../mcpack2pb/*.cpp ../idl_options.pb.cc')) - Sources('../mcpack2pb/generator.cpp'))

def GenProtoCpp(filelist):
    import commands
    for path in filelist.split(' '):
        part = path.partition('/');
        cpppath = os.path.splitext(path)[0] + '.pb.cc'
        cmd = ENV.WorkRoot() + '/third-64/protobuf/bin/protoc' +\
              ' --proto_path=..' \
              ' --proto_path=' + part[0] + \
              ' --proto_path=' + ENV.WorkRoot() + '/third-64/protobuf/include/' + \
              ' --cpp_out=. ' + path
        commands.getoutput(cmd);
        TARGET(cpppath, Prefixes(path), ShellCommands(cmd), CleanFiles(''))
GenProtoCpp(GLOB('./*.proto'))
StaticLibrary('test', Sources(GLOB('*.pb.cc')))

Application('test_base',
            Sources(' '.join(base_ut)) + Sources(' '.join(opt_base_ut), opt_cxx_flags),
            Libraries('libbase_debug.a'))
Application('test_bvar', Sources(GLOB('bvar_*_unittest.cpp'), opt_cxx_flags),
            Libraries('libbvar_debug.a libbase_debug.a'))

bthread_ut = [
    "bthread_butex_unittest.cpp",
    "bthread_execution_queue_unittest.cpp",
    "bthread_key_unittest.cpp",
    "bthread_rwlock_unittest.cpp",
    "bthread_unittest.cpp",
    "bthread_cond_unittest.cpp",
    "bthread_fd_unittest.cpp",
    "bthread_list_unittest.cpp",
    "bthread_sched_yield_unittest.cpp",
    "bthread_work_stealing_queue_unittest.cpp",
    "bthread_countdown_event_unittest.cpp",
    "bthread_futex_unittest.cpp",
    "bthread_mutex_unittest.cpp",
    "bthread_setconcurrency_unittest.cpp",
    "bthread_dispatcher_unittest.cpp",
    "bthread_id_unittest.cpp",
    "bthread_ping_pong_unittest.cpp",
    "bthread_timer_thread_unittest.cpp",
]
for ut in bthread_ut:
    Application(ut[:-4], Sources(ut, opt_cxx_flags),
            Libraries('libbthread_debug.a libbvar_debug.a libbase_debug.a'))

brpc_ut = [
    "brpc_builtin_service_unittest.cpp",
    "brpc_channel_unittest.cpp",
    "brpc_controller_unittest.cpp",
    "brpc_esp_protocol_unittest.cpp",
    "brpc_event_dispatcher_unittest.cpp",
    "brpc_extension_unittest.cpp",
    "brpc_hpack_unittest.cpp",
    "brpc_http_message_unittest.cpp",
    "brpc_http_parser_unittest.cpp",
    "brpc_http_rpc_protocol_unittest.cpp",
    "brpc_http_status_code_unittest.cpp",
    "brpc_hulu_pbrpc_protocol_unittest.cpp",
    "brpc_input_messenger_unittest.cpp",
    "brpc_load_balancer_unittest.cpp",
    "brpc_memcache_unittest.cpp",
    "brpc_mongo_protocol_unittest.cpp",
    "brpc_naming_service_filter_unittest.cpp",
    "brpc_naming_service_unittest.cpp",
    "brpc_nova_pbrpc_protocol_unittest.cpp",
    "brpc_proto_unittest.cpp",
    "brpc_public_pbrpc_protocol_unittest.cpp",
    "brpc_redis_unittest.cpp",
    "brpc_rtmp_unittest.cpp",
    "brpc_server_unittest.cpp",
    "brpc_snappy_compress_unittest.cpp",
    "brpc_socket_map_unittest.cpp",
    "brpc_socket_unittest.cpp",
    "brpc_sofa_pbrpc_protocol_unittest.cpp",
    "brpc_streaming_rpc_unittest.cpp",
    "brpc_uri_unittest.cpp",
]
 
for ut in brpc_ut:
    Application(ut[:-4], Sources(ut),
            Libraries('libtest.a libbrpc_debug.a libbthread_debug.a libbvar_debug.a libbase_debug.a libjson2pb_debug.a libmcpack2pb_debug.a'))

