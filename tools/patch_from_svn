#!/bin/bash
if [ -z "$1" ]; then
    echo "Usage1: patch_from_svn PATCHFILE (generated by 'svn diff -c REVISION')"
    echo "Usage2: patch_from_svn SVN_DIR REVISION"
    exit 1
fi
PATCHFILE=$1
if [ -d "$1/.svn" ]; then
    if [ -z "$2" ]; then
        echo "Second argument must be a SVN revision"
        exit 1
    fi
    SVN_DIR=$1
    REV=$2
    PATCHFILE=$REV.patch
    echo "*** Generating diff of $SVN_DIR@$REV"
    svn diff $SVN_DIR -c $REV > $PATCHFILE
fi

MODIFIED_PATCHFILE="$(basename $PATCHFILE).brpc_os"

cat $PATCHFILE | sed -e 's/src\/baidu\/rpc\//brpc\//g' \
            -e 's/\<baidu\/rpc\//brpc\//g' \
            -e 's/brpc\/test\/test_\(.*\)\.cpp/test\/brpc_\1_unittest.cpp/g' \
            -e 's/\<namespace \+baidu *{/namespace brpc {/g' \
            -e 's/\<namespace \+rpc *{//g' \
            -e 's/} *\/\/ \+namespace \+baidu/} \/\/ namespace brpc/g' \
            -e 's/} *\/\/ \+namespace \+rpc\>//g' \
            -e 's/\<baidu::rpc::/brpc::/g' \
            -e 's/\<rpc::/brpc::/g' \
            -e 's/\<BAIDU_RPC_/BRPC_/g' \
            -e 's/\<protocol\/\(.*\)\.proto/\1.proto/g' \
            -e 's/TEST_F(HttpMessageTest/TEST(HttpMessageTest/g' \
            -e 's/TEST_F(URITest/TEST(URITest/g' \
            -e 's/bthread_cond\.cpp/bthread\/condition_variable.cpp/g' \
            -e 's/bthread_\([^.]*\)\.cpp/bthread\/\1.cpp/g' \
            -e 's/bthread_\([^.]*\)\.h/bthread\/\1.h/g' \
            -e 's/bthread\.h/bthread\/bthread.h/g' \
            -e 's/<\(brpc\/[^>]*\)>/"\1"/g' \
            -e 's/<\(bvar\/[^>]*\)>/"\1"/g' \
            -e 's/<\(base\/[^>]*\)>/"\1"/g' \
            -e 's/<\(bthread\/[^>]*\)>/"\1"/g' \
            -e 's/<\(mcpack2pb\/[^>]*\)>/"\1"/g' \
            > $MODIFIED_PATCHFILE
EXTRA_ARGS=
if [ -z "$DO_RUN" ]; then
    EXTRA_ARGS="--dry-run $EXTRA_ARGS"
    echo "*** This is a dry-run. To really apply, run: DO_RUN=1 tools/patch_from_svn $1"
fi
patch -p0 -u $EXTRA_ARGS < $MODIFIED_PATCHFILE
rm $MODIFIED_PATCHFILE
